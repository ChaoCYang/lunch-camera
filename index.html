import React, { useState } from 'react';
import { Flame, Search, Sparkles, ChefHat, Settings } from 'lucide-react';

const HotpotRecommender = () => {
  const [userInput, setUserInput] = useState('');
  const [recommendations, setRecommendations] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [apiKey, setApiKey] = useState('');
  const [showSettings, setShowSettings] = useState(false);

  // ç«é‹èœå–®è³‡æ–™åº« - å¯ä»¥è¼•é¬†æ“´å±•
  const menuItems = [
    {
      name: "æ¥µå“å’Œç‰›æ¶®æ¶®é‹",
      category: "è‚‰é¡",
      description: "é ‚ç´šA5å’Œç‰›è–„åˆ‡ï¼Œæ²¹èŠ±è±å¯Œï¼Œå…¥å£å³åŒ–",
      characteristics: ["é«˜ç´š", "æ²¹è„‚è±å¯Œ", "è»Ÿå«©", "ç‰›è‚‰", "å¥¢è¯", "ç´°ç·»"],
      cooking: "æ¶®ç‡™3-5ç§’",
      price: "NT$880"
    },
    {
      name: "éº»è¾£è±†è…é‹",
      category: "æ¹¯åº•",
      description: "å››å·éº»è¾£æ¹¯åº•é…è±†è…ï¼Œé¦™è¾£éç™®",
      characteristics: ["è¾£", "éº»", "é‡å£å‘³", "åˆºæ¿€", "è±†è£½å“", "å…§è‡Ÿ"],
      cooking: "ç…®3-5åˆ†é˜",
      price: "NT$380"
    },
    {
      name: "æµ·é®®æ‹¼ç›¤",
      category: "æµ·é®®",
      description: "æ–°é®®è‰è¦ã€èŠ±æã€è›¤è £ã€é®®é­šç‰‡ç¶œåˆæ‹¼ç›¤",
      characteristics: ["æµ·é®®", "é®®ç”œ", "æ¸…æ·¡", "å¥åº·", "ä½è„‚", "è›‹ç™½è³ª"],
      cooking: "æ¶®ç‡™è‡³è®Šè‰²",
      price: "NT$580"
    },
    {
      name: "é¤Šç”ŸèŒè‡è”¬èœç›¤",
      category: "è”¬èœ",
      description: "å¤šç¨®è‡é¡æ­é…æ™‚ä»¤è”¬èœï¼Œæ¸…çˆ½å¥åº·",
      characteristics: ["æ¸…æ·¡", "å¥åº·", "ç´ é£Ÿ", "çº–ç¶­", "é¤Šç”Ÿ", "ä½å¡"],
      cooking: "ç…®2-3åˆ†é˜",
      price: "NT$280"
    }
  ];

  const analyzeWithGemini = async () => {
    if (!userInput.trim()) {
      setError('è«‹è¼¸å…¥æ‚¨æƒ³åƒçš„é£Ÿç‰©ç‰¹æ€§');
      return;
    }

    if (!apiKey.trim()) {
      setError('è«‹å…ˆè¨­å®š Gemini API Key');
      setShowSettings(true);
      return;
    }

    setLoading(true);
    setError('');
    setRecommendations([]);

    try {
      const prompt = `ä½ æ˜¯ä¸€å€‹ç«é‹é¤å»³çš„æ™ºèƒ½æ¨è–¦åŠ©æ‰‹ã€‚

ç”¨æˆ¶æè¿°ï¼šã€Œ${userInput}ã€

é¤å»³èœå–®ï¼š
${menuItems.map((item, idx) => 
  `${idx + 1}. ${item.name} (${item.category})
  æè¿°ï¼š${item.description}
  ç‰¹æ€§ï¼š${item.characteristics.join('ã€')}
  åƒ¹æ ¼ï¼š${item.price}`
).join('\n\n')}

è«‹åˆ†æç”¨æˆ¶çš„æè¿°ï¼Œä¸¦æ¨è–¦æœ€é©åˆçš„èœå“ã€‚è¿”å›JSONæ ¼å¼ï¼š
{
  "recommendations": [
    {
      "itemIndex": èœå“ç´¢å¼•(0-3),
      "matchScore": åŒ¹é…åˆ†æ•¸(0-100),
      "reason": "æ¨è–¦ç†ç”±ï¼ˆç”¨ç¹é«”ä¸­æ–‡ï¼Œ30å­—ä»¥å…§ï¼‰"
    }
  ]
}

è«‹æ¨è–¦1-3é“æœ€åŒ¹é…çš„èœå“ï¼ŒæŒ‰åŒ¹é…åº¦æ’åºã€‚åªè¿”å›JSONï¼Œä¸è¦å…¶ä»–æ–‡å­—ã€‚`;

      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            contents: [
              {
                parts: [
                  {
                    text: prompt
                  }
                ]
              }
            ],
            generationConfig: {
              temperature: 0.7,
              maxOutputTokens: 1000,
            }
          })
        }
      );

      if (!response.ok) {
        throw new Error('API è«‹æ±‚å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key æ˜¯å¦æ­£ç¢º');
      }

      const data = await response.json();
      
      if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
        throw new Error('API è¿”å›æ ¼å¼éŒ¯èª¤');
      }

      const text = data.candidates[0].content.parts[0].text;
      const cleanText = text.replace(/```json|```/g, '').trim();
      const result = JSON.parse(cleanText);

      const recommendedItems = result.recommendations.map(rec => ({
        ...menuItems[rec.itemIndex],
        matchScore: rec.matchScore,
        reason: rec.reason
      }));

      setRecommendations(recommendedItems);
    } catch (err) {
      console.error('æ¨è–¦éŒ¯èª¤:', err);
      setError(err.message || 'æ¨è–¦ç³»çµ±æš«æ™‚ç„¡æ³•ä½¿ç”¨ï¼Œè«‹æª¢æŸ¥ API Key æˆ–ç¨å¾Œå†è©¦');
    } finally {
      setLoading(false);
    }
  };

  const handleKeyPress = (e) => {
    if (e.key === 'Enter' && !loading) {
      analyzeWithGemini();
    }
  };

  const saveApiKey = () => {
    if (apiKey.trim()) {
      localStorage.setItem('gemini_api_key', apiKey);
      setShowSettings(false);
      setError('');
    }
  };

  // è¼‰å…¥å„²å­˜çš„ API Key
  React.useEffect(() => {
    const saved = localStorage.getItem('gemini_api_key');
    if (saved) {
      setApiKey(saved);
    }
  }, []);

  return (
    <div className="min-h-screen bg-gradient-to-br from-red-50 to-orange-50 p-6">
      <div className="max-w-4xl mx-auto">
        {/* æ¨™é¡Œ */}
        <div className="text-center mb-8">
          <div className="flex items-center justify-center gap-3 mb-4">
            <Flame className="w-10 h-10 text-red-500" />
            <h1 className="text-4xl font-bold text-gray-800">ç«é‹æ™ºèƒ½æ¨è–¦</h1>
            <Flame className="w-10 h-10 text-red-500" />
          </div>
          <p className="text-gray-600">å‘Šè¨´æˆ‘å€‘æ‚¨æƒ³åƒä»€éº¼ï¼ŒAI ç‚ºæ‚¨æ¨è–¦æœ€é©åˆçš„èœå“</p>
          <button
            onClick={() => setShowSettings(!showSettings)}
            className="mt-3 text-sm text-gray-500 hover:text-gray-700 flex items-center gap-1 mx-auto"
          >
            <Settings className="w-4 h-4" />
            {apiKey ? 'API Key å·²è¨­å®š' : 'è¨­å®š API Key'}
          </button>
        </div>

        {/* API Key è¨­å®š */}
        {showSettings && (
          <div className="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <h3 className="text-lg font-semibold text-gray-800 mb-3">Gemini API Key è¨­å®š</h3>
            <p className="text-sm text-gray-600 mb-3">
              è«‹åˆ° <a href="https://makersuite.google.com/app/apikey" target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline">Google AI Studio</a> å–å¾—å…è²» API Key
            </p>
            <div className="flex gap-3">
              <input
                type="password"
                value={apiKey}
                onChange={(e) => setApiKey(e.target.value)}
                placeholder="è¼¸å…¥æ‚¨çš„ Gemini API Key"
                className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
              />
              <button
                onClick={saveApiKey}
                className="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors"
              >
                å„²å­˜
              </button>
            </div>
          </div>
        )}

        {/* è¼¸å…¥å€ */}
        <div className="bg-white rounded-2xl shadow-lg p-6 mb-6">
          <label className="block text-sm font-medium text-gray-700 mb-3">
            æè¿°æ‚¨æƒ³åƒçš„é£Ÿç‰©ç‰¹æ€§
          </label>
          <div className="flex gap-3">
            <input
              type="text"
              value={userInput}
              onChange={(e) => setUserInput(e.target.value)}
              onKeyPress={handleKeyPress}
              placeholder="ä¾‹å¦‚ï¼šæˆ‘æƒ³åƒè¾£çš„ã€æˆ‘æƒ³åƒæ¸…æ·¡å¥åº·çš„ã€æˆ‘æƒ³åƒé«˜ç´šçš„è‚‰é¡..."
              className="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
            />
            <button
              onClick={analyzeWithGemini}
              disabled={loading}
              className="px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center gap-2 transition-colors"
            >
              {loading ? (
                <>
                  <Sparkles className="w-5 h-5 animate-spin" />
                  åˆ†æä¸­
                </>
              ) : (
                <>
                  <Search className="w-5 h-5" />
                  æ¨è–¦èœå“
                </>
              )}
            </button>
          </div>
          {error && (
            <p className="mt-3 text-red-500 text-sm">{error}</p>
          )}
        </div>

        {/* æ¨è–¦çµæœ */}
        {recommendations.length > 0 && (
          <div className="space-y-4">
            <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
              <ChefHat className="w-6 h-6" />
              ç‚ºæ‚¨æ¨è–¦
            </h2>
            {recommendations.map((item, idx) => (
              <div
                key={idx}
                className="bg-white rounded-xl shadow-md p-6 hover:shadow-lg transition-shadow"
              >
                <div className="flex justify-between items-start mb-3">
                  <div>
                    <h3 className="text-xl font-bold text-gray-800">{item.name}</h3>
                    <span className="inline-block px-3 py-1 bg-red-100 text-red-700 rounded-full text-sm mt-2">
                      {item.category}
                    </span>
                  </div>
                  <div className="text-right">
                    <div className="text-2xl font-bold text-red-500">{item.price}</div>
                    <div className="text-sm text-gray-500 mt-1">
                      åŒ¹é…åº¦: {item.matchScore}%
                    </div>
                  </div>
                </div>
                
                <p className="text-gray-600 mb-3">{item.description}</p>
                
                <div className="bg-yellow-50 border-l-4 border-yellow-400 p-3 mb-3">
                  <p className="text-sm text-gray-700">
                    <span className="font-semibold">æ¨è–¦ç†ç”±ï¼š</span>
                    {item.reason}
                  </p>
                </div>

                <div className="flex flex-wrap gap-2 mb-3">
                  {item.characteristics.map((char, i) => (
                    <span
                      key={i}
                      className="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm"
                    >
                      {char}
                    </span>
                  ))}
                </div>

                <p className="text-sm text-gray-500">
                  <span className="font-semibold">çƒ¹é£ªå»ºè­°ï¼š</span>
                  {item.cooking}
                </p>
              </div>
            ))}
          </div>
        )}

        {/* ä½¿ç”¨æç¤º */}
        {recommendations.length === 0 && !loading && (
          <div className="bg-white rounded-xl shadow-md p-6">
            <h3 className="text-lg font-semibold text-gray-800 mb-4">ğŸ’¡ ä½¿ç”¨æç¤º</h3>
            <ul className="space-y-2 text-gray-600">
              <li>â€¢ æè¿°æ‚¨å–œæ­¡çš„å£å‘³ï¼šè¾£çš„ã€æ¸…æ·¡çš„ã€é®®ç”œçš„</li>
              <li>â€¢ æè¿°é£Ÿæé¡å‹ï¼šè‚‰é¡ã€æµ·é®®ã€è”¬èœ</li>
              <li>â€¢ æè¿°åå¥½ï¼šå¥åº·çš„ã€é«˜ç´šçš„ã€é¤Šç”Ÿçš„</li>
              <li>â€¢ æˆ–ç›´æ¥èªªï¼šæˆ‘æƒ³åƒéº»è¾£çš„ã€æˆ‘æƒ³åƒç‰›è‚‰</li>
            </ul>
          </div>
        )}
      </div>
    </div>
  );
};

export default HotpotRecommender;
